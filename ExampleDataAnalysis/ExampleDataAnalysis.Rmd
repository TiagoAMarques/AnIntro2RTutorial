---
title: "An example data analysis to illustrate reproducibility"
author: "Tiago A. Marques"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#for function kable for creating tables
library(knitr)
```


# Introduction

Let us imagine that you are doing a study, perhaps your Master thesis dissertation, evaluating the relationship between the number of species of insects as a function the number of species of plants, considering several types of habitats. In each type of habitat you conducted surveys at different plots, counting the number of plant species, the number of insect species, and recording these values and their corresponding habitat.

# Do not touch this section (field work season 1 in progress)

This section simulates you going to the field, collecting and recording the data. It will take you months to do so, but here it happens in a split of a second.

The next chunk of code, only visible on the .Rmd file, is not to be touched. It simulates data with some useful features and creates the file with the data, "fakedata.csv", which you use below
```{r,echo=FALSE}
#do not touch this code chunck
#this simulates the data
# this is not visible in the output, since the chunk option echo is FALSE: "echo=FALSE"
set.seed(123)
n<-1000
mydata<-data.frame(ID=1:n,nspI=NA,nspP=NA,habitat=NA)
mydata$nspP<-round(runif(n,0,10))
mydata$habitat<-rep(c("Hab1","Hab2","Hab3","Hab4"),each=n/4)
mydata$nspI<-round(2+3*mydata$nspP+ifelse(mydata$habitat=="Hab1",10,ifelse(mydata$habitat=="Hab2",20,ifelse(mydata$habitat=="Hab3",30,40)))+rpois(n,5))
write.csv(mydata,file="fakedata.csv",row.names = FALSE,quote=FALSE)
```

# Your analysis

The first thing to do is to read in the data that you spent so much effort collecting. This reads the data

```{r}
# This is where you will change the input file when you have completed the instructions below
mydata <- read.csv("fakedata.csv")
```

We can take a look a the data

```{r}
kable(head(mydata))
```

explore the data structure

```{r}
str(mydata)
```

see a summary of it

```{r}
kable(summary(mydata))
```


and we see that we have collected `r nrow(mydata)` observations. We can see that the number of insects seems to increase with the number of plants, and it also seems to be a function of the habitat. We have a balanced number of observations per habitat

```{r}
barplot(table(mydata$habitat),ylab="number of observations",xlab="Habitat")
```

We can look at the data:

```{r}
par(mfrow=c(1,2))
boxplot(mydata$nspI~mydata$habitat,ylab="number of insect species",xlab="Habitat")
boxplot(mydata$nspI~mydata$nspP,ylab="number of insect species",xlab="number of plant species")
```

and we can say all sorts of things about the data, that for example 

* the mean number of insects per plot in habitat 1 is `r mean(mydata$nspI[mydata$habitat=="Hab1"])`, 

* the mean number of insects per plot  in habitat 2 is `r mean(mydata$nspI[mydata$habitat=="Hab2"])`, 

* the mean number of insects per plot in habitat 3 is `r mean(mydata$nspI[mydata$habitat=="Hab3"])` 

* the mean number of insects per plot in habitat 4 is `r mean(mydata$nspI[mydata$habitat=="Hab4"])` 

* the overall mean number of insects per plot is `r mean(mydata$nspI)`. 

* The minimum, median and maximum number of species of insects per plot were `r min(mydata$nspI)`, `r median(mydata$nspI)`, `r max(mydata$nspI)`, respectively. 

Remember, if you want to see these numbers with less decimals, just round them as for the global mean number of insect species (i.e. per plot, pooled across habitats) here: `r round(mean(mydata$nspI),1)`.

We could even fit a linear model to the data to explain how the number of insect species per plot varies with the number of plant species:

```{r}
par(mfrow=c(1,1))
plot(mydata$nspI~mydata$nspP,ylab="number of insect species",xlab="number of plant species")
lm1<-lm(nspI~nspP,data=mydata)
abline(lm1,lty=2,col=3,lwd=3)
```

You would see that the number of species of insects increases with the number of plant species, in particular, for each new species of plant, there will be on average `r round(coef(lm1)[2],2)` more species of insects. Clearly if you increase plant diversity you have more species of insects, so that could be a good way of increasing biodiversity^[we assume here there is a causal relation between the number of plant species and the number of insect species. However, we only have an observational study, not an experimental study, so that is not the case for granted. Nonetheless, let us assume here that the relation is causal indeed, so that the story has a happy ending with you publishing a paper in Nature or some such!].



# The problem

You are happy. But your supervisor tells you: "Great work, but... you actually forgot to sample two important habitats.". Damn, you think, more work to do:

1. You need to go back to the field, and that's for sure. 
2. And then you have to redo the entire analysis... Or do you?

If you work with dynamic reports, redoing the analysis will be easy-peasy! Let's see why/how below.

# Do not touch this section (field work season 2 in progress)

Lets pretend you went back to the field, collected more data on those new two habitats, and the file with the data for all the habitats is now `fakedata2.csv`. Do not touch any of the code in the chunk below (code not visible in the output file). This code just creates more data, the file `fakedata2.csv`, as if you had gone to the field again and puts all the data from the 6 habitats in a single file.

```{r,echo=FALSE}
#do not touch this code chunck
#this simulates the data
# this is not visible in the output, since the chunk option echo is FALSE: "echo=FALSE"
set.seed(123)
n2<-400
mydata2<-data.frame(ID=(nrow(mydata)+1):(nrow(mydata)+n2),nspI=NA,nspP=NA,habitat=NA)
mydata2$nspP<-round(runif(n2,0,10))
mydata2$habitat<-rep(c("Hab5","Hab6"),each=n2/2)
mydata2$nspI<-round(2+3*mydata2$nspP+ifelse(mydata2$habitat=="Hab5",0,60)+rpois(n2,5))
mydata2<-as.data.frame(rbind(mydata,mydata2))
write.csv(mydata2,file="fakedata2.csv",row.names = FALSE,quote=FALSE)
```

# Your task

Now, you just have to wonder at what dynamic reports are best at. If you had just a plain old word with numbers you took from some excel calculations, you would have to redo all the analysis. Here, you don't. See for yourself.

* create a new ".Rmd" file that reads `fakedata2.csv` instead of `fakedata.csv`. Basically you can just go to windows explorer, create a copy of `ExampleDataAnalysis.Rmd`, so copy-paste the file `ExampleDataAnalysis.Rmd`, and name it say `ExampleDataAnalysis2.Rmd` 

* edit the **line of code above, in the new file you just created** that reads `mydata <- read_excel("fakedata2.csv")` to become `mydata <- read_excel("fakedata2.csv")` (note this line will therefore now read the file `fakedata2.csv` that contains all the data, with 6, not just 4, habitats)

* compile the file `ExampleDataAnalysis2.Rmd`

* check how all the results are updated immediately. 

While you have to do new field work, all the analysis is reproduced by simply recompiling the same document, reading the new data instead of the old data. 

This will save you days/weeks/months of work when it is for real!
